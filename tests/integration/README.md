# 整体测试文档 - 初中数学残局挑战系统

## 测试概述

该文档介绍了初中数学残局挑战系统的整体测试方案，包括HTTP API测试和WebSocket通信测试。测试脚本验证了系统的完整功能，确保前后端交互正常。

## 测试环境

- **后端服务**: 运行在 `http://localhost:8000`
- **WebSocket服务**: 运行在 `ws://localhost:8000/ws`
- **测试框架**: Python 3.10+
- **依赖库**: 
  - `httpx`: 用于HTTP API测试
  - `websockets`: 用于WebSocket通信测试

## 测试用例

### 1. HTTP API测试

| 测试项 | 描述 | 预期结果 |
|--------|------|----------|
| 健康检查 | 测试API服务是否正常运行 | 返回状态码200和正常状态信息 |
| 获取提示API | 测试根据解题步骤获取提示 | 返回苏格拉底式提示 |
| 直接使用AI | 测试直接调用AI获取提示 | 返回AI生成的提示 |

### 2. WebSocket测试

| 测试项 | 描述 | 预期结果 |
|--------|------|----------|
| 连接测试 | 测试WebSocket连接是否成功 | 连接建立成功 |
| Ping-Pong测试 | 测试心跳机制 | 发送ping后收到pong响应 |
| 解题步骤测试 | 测试发送解题步骤获取提示 | 收到苏格拉底式提示 |
| 多消息交互 | 测试连续发送多个测试用例 | 每个请求都能收到正确响应 |
| 错误报告测试 | 测试错误报告功能 | 收到确认消息 |

### 3. 初中数学测试用例

测试脚本包含了5个初中数学测试用例：

1. **一元一次方程**: 解方程：2x + 3 = 7
2. **二元一次方程组**: 解方程组：2x + y = 5；x - y = 1
3. **二次方程**: 解方程：x² - 5x + 6 = 0
4. **几何证明**: 在△ABC中，AB=AC，证明∠B=∠C
5. **函数图像**: 画出函数y = 2x + 1的图像

## 测试运行方法

### 1. 安装依赖

```bash
pip install httpx websockets
```

### 2. 启动后端服务

确保后端服务已启动并运行在8000端口：

```bash
cd backend
python main.py
```

### 3. 运行整体测试

```bash
cd /Users/tianpengzhang/playground/endgame
python tests/integration/test_full_stack.py
```

### 4. 测试输出示例

```
============================================================
初中数学残局挑战系统 - 整体测试
============================================================
测试时间: 623561.646117375
测试地址: http://localhost:8000
WebSocket地址: ws://localhost:8000/ws
============================================================
=== 测试HTTP API接口 ===
1. 测试健康检查API...
✅ 健康检查API测试通过

2. 测试获取提示API...
   测试用例 1: 一元一次方程
   ✅ 响应: 你用了什么方法解方程？是否有更简便的方法？...
   测试用例 2: 二元一次方程组
   ✅ 响应: 你用了什么方法解方程？是否有更简便的方法？...
   测试用例 3: 二次方程
   ✅ 响应: 你用了什么方法解方程？是否有更简便的方法？...

3. 测试直接使用AI获取提示...
   ✅ AI响应: 你在把不等式左边的-5移到右边时，符号需要发生变化吗？...

✅ 所有HTTP API测试通过！

=== 测试WebSocket连接 ===
1. WebSocket连接成功
2. 测试ping消息...
   ✅ ping-pong测试通过

3. 测试解题步骤消息...
   测试用例: 一元一次方程
   ✅ WebSocket响应: 你用了什么方法解方程？是否有更简便的方法？...

✅ WebSocket测试通过！

=== 测试WebSocket多消息交互 ===
1. WebSocket连接成功

2. 测试用例 1: 一元一次方程
   ✅ 响应: 你用了什么方法解方程？是否有更简便的方法？...

2. 测试用例 2: 二元一次方程组
   ✅ 响应: 你用了什么方法解方程？是否有更简便的方法？...

3. 测试错误报告...
   ✅ 错误报告响应: 错误报告已接收

✅ WebSocket多消息交互测试通过！

============================================================
🎉 所有测试通过！前后端交互正常！
============================================================
```

## 测试脚本说明

### 主要函数

1. **test_http_api**: 测试HTTP API接口，包括健康检查、获取提示和直接使用AI
2. **test_websocket_connection**: 测试WebSocket连接、ping-pong机制和基本消息交互
3. **test_websocket_multiple_messages**: 测试WebSocket多消息交互和错误报告
4. **main**: 主测试函数，运行所有测试用例

### 配置参数

- **BASE_URL**: HTTP API基础地址
- **WS_URL**: WebSocket服务地址
- **HTTP_TIMEOUT**: HTTP请求超时时间
- **WS_TIMEOUT**: WebSocket操作超时时间

## 测试扩展

可以通过修改`MATH_TEST_CASES`列表添加更多测试用例，每个测试用例包含：

- `id`: 测试用例ID
- `name`: 测试用例名称
- `content`: 解题步骤内容
- `expected_type`: 预期响应类型

## 注意事项

1. 确保后端服务已启动并运行在正确的端口
2. 测试前请确保安装了所有依赖库
3. 测试过程中保持网络连接稳定
4. 测试脚本会自动处理连接和超时情况

## 故障排除

- **HTTP请求超时**: 检查后端服务是否正常运行，或增加`HTTP_TIMEOUT`值
- **WebSocket连接失败**: 检查WebSocket服务是否正常运行，或后端服务是否支持WebSocket
- **测试用例失败**: 检查测试用例内容是否符合预期，或后端服务逻辑是否有变化

## 结论

通过运行整体测试脚本，可以验证初中数学残局挑战系统的完整功能，确保前后端交互正常。测试脚本提供了全面的测试覆盖，包括HTTP API和WebSocket通信，以及多个初中数学测试用例。